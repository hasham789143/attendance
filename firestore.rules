/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and attendance records,
 *              while also providing admin access and public read access where appropriate.
 *
 * Data Structure:
 * - /users/{userId}: User profile information, accessible only by the user themselves and admins.
 * - /sessions/class-current: The current active class attendance session.
 * - /sessions/class-current/records/{userId}: Live attendance records for the active class session, accessible only by admins.
 * - /sessions/hostel-current: The current active hostel attendance session.
 * - /sessions/hostel-current/records/{userId}: Live attendance records for the active hostel session, accessible only by admins.
 * - /sessions/{sessionId}: Archived attendance sessions, accessible only by admins.
 * - /sessions/{sessionId}/records/{recordId}: Individual attendance records for historical sessions, accessible only by admins.
 * - /chats/{studentUid}/messages/{messageId}: Chat messages for a specific student, accessible by the student and admins.
 * - /settings/attendance: Application-wide settings, accessible only by admins.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied.
 * - Admin role is required for managing sessions, records and settings.
 * - Chat messages are scoped to individual students, with admin oversight.
 * - Current sessions and their associated records are separated from historical sessions for access control.
 * - All write operations are protected by authorization checks, and non-existent documents cannot be updated or deleted.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data, and admins to manage all user data.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if isSignedIn() && (isOwner(userId) || isAdmin())
     * @deny (get, create, update, delete) if !isSignedIn()
     * @principle Enforces document ownership for writes and requires authentication for all access.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin());
      allow list: if false; // Listing users is not allowed

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isSignedIn() && (isOwner(userId) && resource.data.uid == request.resource.data.uid || isAdmin()) && resource != null;
      allow delete: if isSignedIn() && (isOwner(userId) && resource.data.uid == userId || isAdmin()) && resource != null;
    }

    /**
     * @description Allows admins to manage the current class attendance session.
     * @path /sessions/class-current
     * @allow (get, create, update, delete) if isAdmin()
     * @deny (get, create, update, delete) if !isAdmin()
     * @principle Requires admin role for managing sessions.
     */
    match /sessions/class-current {
      allow get: if isAdmin();
      allow list: if false; // Only a single document, listing is not applicable

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;

       match /records/{userId} {
          allow get: if isAdmin();
          allow list: if isAdmin();

          allow create: if isAdmin();
          allow update: if isAdmin() && resource != null;
          allow delete: if isAdmin() && resource != null;
        }
    }

        /**
     * @description Allows admins to manage the current hostel attendance session.
     * @path /sessions/hostel-current
     * @allow (get, create, update, delete) if isAdmin()
     * @deny (get, create, update, delete) if !isAdmin()
     * @principle Requires admin role for managing sessions.
     */
    match /sessions/hostel-current {
      allow get: if isAdmin();
      allow list: if false; // Only a single document, listing is not applicable

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;

       match /records/{userId} {
          allow get: if isAdmin();
          allow list: if isAdmin();

          allow create: if isAdmin();
          allow update: if isAdmin() && resource != null;
          allow delete: if isAdmin() && resource != null;
        }
    }

    /**
     * @description Allows admins to manage archived attendance sessions.
     * @path /sessions/{sessionId}
     * @allow (get, create, update, delete) if isAdmin()
     * @deny (get, create, update, delete) if !isAdmin()
     * @principle Requires admin role for managing sessions.
     */
    match /sessions/{sessionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;

      /**
       * @description Allows admins to manage individual attendance records for a specific historical session.
       * @path /sessions/{sessionId}/records/{recordId}
       */
      match /records/{recordId} {
        allow get: if isAdmin();
        allow list: if isAdmin();

        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
      }
    }

    /**
     * @description Allows students to read and write their own chat messages, and admins to manage all chat messages.
     * @path /chats/{studentUid}/messages/{messageId}
     */
    match /chats/{studentUid}/messages/{messageId} {
      allow get: if isSignedIn() && (isOwner(studentUid) || isAdmin());
      allow list: if isSignedIn() && (isOwner(studentUid) || isAdmin());

      allow create: if isSignedIn() && (request.resource.data.senderUid == request.auth.uid && isOwner(studentUid) || isAdmin());
      allow update: if isSignedIn() && (isOwner(studentUid) || isAdmin()) && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null; // Only admins can delete messages
    }

    /**
     * @description Allows admins to manage application-wide settings.
     * @path /settings/attendance
     */
    match /settings/attendance {
      allow get: if isAdmin();
      allow list: if false; // Only a single document, listing is not applicable

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

   }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin() {
    return request.auth.token.role == 'admin';
  }
}