/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a role-based access control model, granting 'admin' and 'viewer' roles extensive permissions.
 * Users can only manage their own user documents.
 * Attendance sessions can be managed by admins.
 * Chat messages are segregated per user, with admin access to all chats.
 * Settings can be managed by admins.
 * @data_structure
 * /users/{userId}: Stores user profile information, where userId matches the Firebase Auth UID.
 * /sessions/class-current: Stores the current active class attendance session (single document).
 * /sessions/class-current/records/{userId}: Stores live attendance records for each student in the current class session.
 * /sessions/hostel-current: Stores the current active hostel attendance session (single document).
 * /sessions/hostel-current/records/{userId}: Stores live attendance records for each resident in the current hostel session.
 * /sessions/{sessionId}: Stores archived attendance sessions.
 * /sessions/{sessionId}/records/{recordId}: Stores individual attendance records for specific historical sessions.
 * /chats/{studentUid}/messages/{messageId}: Stores chat messages for a specific student.
 * /settings/attendance: Stores application-wide settings (single document).
 * @key_security_decisions
 * - Users can only create their own user document (self-registration).
 * - Users cannot list other users.
 * - Admins have read and write access to attendance sessions and settings.
 * - Chats are private per student, but admins can read all chats.
 * - Roles 'admin' and 'viewer' have broad access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own user document. Admins and viewers have the same access.
     * @path /users/{userId}
     * @allow (create) User with UID matching {userId} can create their document.
     * @allow (get, update, delete) User with UID matching {userId} can get, update, and delete their document. Admins and viewers also have access.
     * @deny (create) User with UID not matching {userId} cannot create a document.
     * @deny (get, update, delete) User with UID not matching {userId} cannot get, update, and delete this document.
     * @principle Enforces document ownership for writes, self-creation for users.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get: if isOwner(userId) || isAdminOrViewer();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == request.auth.uid;
      allow update: if isOwner(userId) || isAdminOrViewer();
      allow delete: if isOwner(userId) || isAdminOrViewer();
    }

    /**
     * @description Allows admins and viewers to manage the current class attendance session.
     * @path /sessions/class-current
     * @allow (get, list) Any authenticated user can read the current session.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete the session.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete the session.
     * @principle Restricts write access to admins and viewers.
     */
    match /sessions/class-current {
        function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }

    /**
     * @description Allows admins and viewers to manage live attendance records for the current class session.
     * @path /sessions/class-current/records/{userId}
     * @allow (get, list) Any authenticated user can read live attendance records.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete live attendance records.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete live attendance records.
     * @principle Restricts write access to admins and viewers.
     */
    match /sessions/class-current/records/{userId} {
      function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }

       /**
     * @description Allows admins and viewers to manage the current hostel attendance session.
     * @path /sessions/hostel-current
     * @allow (get, list) Any authenticated user can read the current session.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete the session.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete the session.
     * @principle Restricts write access to admins and viewers.
     */
    match /sessions/hostel-current {
         function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }

    /**
     * @description Allows admins and viewers to manage live attendance records for the current hostel session.
     * @path /sessions/hostel-current/records/{userId}
     * @allow (get, list) Any authenticated user can read live attendance records.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete live attendance records.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete live attendance records.
     * @principle Restricts write access to admins and viewers.
     */
    match /sessions/hostel-current/records/{userId} {
      function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }

    /**
     * @description Allows admins and viewers to manage archived attendance sessions.
     * @path /sessions/{sessionId}
     * @allow (get, list) Any authenticated user can read archived sessions.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete archived sessions.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete archived sessions.
     * @principle Restricts write access to admins and viewers.
     */
    match /sessions/{sessionId} {
      function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }

    /**
     * @description Allows admins and viewers to manage individual attendance records for historical sessions.
     * @path /sessions/{sessionId}/records/{recordId}
     * @allow (get, list) Any authenticated user can read historical attendance records.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete historical attendance records.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete historical attendance records.
     * @principle Restricts write access to admins and viewers.
     */
    match /sessions/{sessionId}/records/{recordId} {
      function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }

    /**
     * @description Allows students to read their own chat messages, and admins and viewers to read all chat messages. Admins and viewers can send messages to any student.
     * @path /chats/{studentUid}/messages/{messageId}
     * @allow (get, list) User with UID matching {studentUid} can read their chat messages. Admins and viewers can also read all messages.
     * @allow (create) Admins and viewers can create messages.
     * @deny (create) Users cannot create messages directly.
     * @deny (get, list) User with UID not matching {studentUid} cannot read these messages (unless they are admins and viewers).
     * @principle Enforces chat privacy for students, allows admin access.
     */
    match /chats/{studentUid}/messages/{messageId} {
      function isOwner(studentUid) {
        return request.auth.uid == studentUid;
      }
      function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if isOwner(studentUid) || isAdminOrViewer();
      allow create: if isAdminOrViewer();
      allow update, delete: if false;
    }

    /**
     * @description Allows admins and viewers to manage application-wide settings.
     * @path /settings/attendance
     * @allow (get, list) Any authenticated user can read the settings.
     * @allow (create, update, delete) Admins and viewers can create, update, and delete the settings.
     * @deny (create, update, delete) Non-admins and non-viewers cannot create, update, or delete the settings.
     * @principle Restricts write access to admins and viewers.
     */
    match /settings/attendance {
         function isAdminOrViewer() {
        return request.auth.token.role == 'admin' || request.auth.token.role == 'viewer';
      }
      allow get, list: if true;
      allow create, update, delete: if isAdminOrViewer();
    }
  }
}