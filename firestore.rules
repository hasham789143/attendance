rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for the admin custom claim on the user's auth token.
      return isSignedIn() && request.auth.token.role == 'admin';
    }

    // == USERS ==
    // A user can read/update their own profile.
    // An admin can read/list all profiles and delete them.
    // A new user can create their own profile.
    match /users/{userId} {
      allow get, update: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId); // Allows a user to create their own document
      allow list, delete: if isAdmin();
    }

    // == SETTINGS ==
    // Anyone can read the registration settings (for the public sign-up page).
    // Only admins can change the settings.
    match /settings/attendance {
      allow get: if true;
      allow write: if isAdmin();
    }

    // == CHATS ==
    // A user can read and write to their own chat.
    // An admin can read and write to any chat.
    match /chats/{studentUid}/{document=**} {
      allow read, write: if isOwner(studentUid) || isAdmin();
    }
    
    // == SESSIONS ==
    // Any authenticated user can read session data (for dashboards).
    // Only admins can create, update, or delete session data.
    match /sessions/{document=**} {
        allow get, list: if isSignedIn();
        allow write: if isAdmin();
    }

  }
}
