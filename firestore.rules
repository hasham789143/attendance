/**
 * @description This ruleset enforces a role-based access control model, where 'admin' and 'viewer' roles have broad read and write access.
 * @dataStructure The data is organized into collections for users, sessions, and chats. User profiles are stored under `/users/{userId}`, attendance sessions under `/sessions/{sessionId}`, and chat messages under `/chats/{studentUid}/messages/{messageId}`.
 * @keySecurityDecisions
 *   - Broad Access for Roles: Both 'admin' and 'viewer' roles are granted wide read and write permissions across the database.
 *   - No Data Validation: The rules do not enforce any data validation beyond verifying the existence of a user and checking their role.
 *   - User Listing Allowed: The rules permit listing all users, potentially exposing PII. This should be carefully reviewed in a production environment.
 *   - Reliance on Client: The security relies heavily on the client to provide valid data, as there are minimal checks on write operations.
 *   - Insecure List Operation: Allows listing of ALL sessions and ALL chats, which is likely to expose private data to unauthorized users.
 *   - Relies on `get()` calls in rules: This is slow and expensive, and can lead to exceeding read quotas.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows admins and viewers to read and write user profiles.
     * @path /users/{userId}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /users/{userId} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }

    /**
     * @description Allows admins and viewers to read and write attendance sessions.
     * @path /sessions/{sessionId}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /sessions/{sessionId} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }
    
    /**
     * @description Allows admins and viewers to read and write attendance sessions in "class-current" sessions.
     * @path /sessions/class-current
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /sessions/class-current {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }

    /**
     * @description Allows admins and viewers to read and write attendance sessions records in "class-current" sessions.
     * @path /sessions/class-current/records/{userId}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /sessions/class-current/records/{userId} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }
    
        /**
     * @description Allows admins and viewers to read and write attendance sessions in "hostel-current" sessions.
     * @path /sessions/hostel-current
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /sessions/hostel-current {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }

    /**
     * @description Allows admins and viewers to read and write attendance sessions records in "hostel-current" sessions.
     * @path /sessions/hostel-current/records/{userId}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /sessions/hostel-current/records/{userId} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }

    /**
     * @description Allows admins and viewers to read and write attendance sessions.
     * @path /sessions/{sessionId}/records/{recordId}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /sessions/{sessionId}/records/{recordId} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }

    /**
     * @description Allows admins and viewers to read and write chat messages.
     * @path /chats/{studentUid}/messages/{messageId}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /chats/{studentUid}/messages/{messageId} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }
        /**
     * @description Allows admins and viewers to read and write application settings.
     * @path /settings/attendance
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /settings/attendance {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }
        
    /**
     * @description Generic rule for all other collections. Allows admins and viewers to read and write.
     * @path /{document=**}
     * @allow (read, write) User with role 'admin' or 'viewer'.
     * @deny (read, write) User without role 'admin' or 'viewer'.
     * @principle Grants broad access based on user role.
     */
    match /{document=**} {
      allow get: if isAdmin() || isViewer();
      allow list: if isAdmin() || isViewer();
      allow create: if isAdmin() || isViewer();
      allow update: if isAdmin() || isViewer();
      allow delete: if isAdmin() || isViewer();
    }

    /**
     * @description Checks if the user has the 'admin' role.
     * @return True if the user is authenticated and has the 'admin' role.
     */
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Checks if the user has the 'viewer' role.
     * @return True if the user is authenticated and has the 'viewer' role.
     */
    function isViewer() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'viewer';
    }
  }
}